---
title: "Roe Deer Logistic Regression Analysis"
author: "Ashlee Mikkelsen"
date: "`r Sys.Date()`"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

# Introduction

This is the logistic regression file for the Roe deer- vehicle collision analysis for Viken kommune. Andreas, Rick and I took a contract from the kommune to estimate whether decreasing the speed limit on roads by 10 km/hr would reduce the number of vehicle collisions with Roe deer. 

# Environment

```{r}

rm(list=ls())

```

## Set working directory

```{r}

setwd("~Rprojects\\RoeDeerVehCol")

```


## Load packages

```{r}

library(ggplot2)
library(lme4)
library(wiqid)
library(AICcmodavg)
library(ggeffects)
library(corrplot)


```


## set graphing theme

```{r, include=FALSE}

mytheme <- theme(
    axis.text = element_text(size = 12,face = "bold"),
    axis.title = element_text(size = 14, face = "bold"),
    panel.grid.major = element_line(color = "grey92"),
    panel.grid.minor = element_line(color = "grey96"),
    panel.background = element_rect(fill = "white"),
    axis.line = element_line(colour = "black",linewidth = 1),
    axis.ticks = element_line(linewidth = 1),
    legend.position = "top"
    )
theme_set(mytheme)

P <- palette(viridis(40))
P <- palette(viridis(40))

```


## Functions

```{r}

logit2prob <- function(logit){
  odds <- exp(logit)
  prob <- odds / (1 + odds)
  return(prob)
}



rsq <- function (x, y) cor(x, y) ^ 2

```


## Load Data

```{r}

RoeDeer.df <- read.csv("Data\\df_VikenRoeDeer_7080Combined.csv",
                         header=TRUE)
RoeDeer.df$f.speed <- as.factor(RoeDeer.df$speed)


```


### Data description

The original data file has 21090 observations and was processed by Rick prior to analysis. Explanation of data file:
Columns
1: Object ID- Unique identifyer for each record
2: id- secondary identifyer identifies the response category of the observation and the observation number within the response category (1_1 is the first observation of the 1 response category)
3: response- category 1= a collision 0= randomly drawn background points that are psuedo-absence points.
4: X- continuous variable UTM northing of the record
5: Y- continuous variable UTM easting of the record
6: speed- discrete numeric Speed limit of road segment closest straight line distance from the record
7: ADT- discrete numeric Average daily traffic volume of road segment closest straight-line distance from the record.
8: efficiency-  continuous variable (0-1) indexing the straightness of the road in which 1= perfectly straight and records less than 1 have some level of curvature. 
9: cover_fo- continuous variable (0-1) proportion of forest cover calculated as area of habitat variable within a 100m buffer divided by the area of the 100m buffer * 100. 
10: cover_agri- continuous variable (0-1) proportion of forest cover calculated as area of habitat variable within a 100m buffer divided by the area of the 100m buffer * 100. 
11: cover_wa- continuous variable (0-1) proportion of water calculated as area of habitat variable within a 100m buffer divided by the area of the 100m buffer * 100. 
12: cover_urban- continuous variable (0-1) proportion of urban land cover calculated as area of habitat variable within a 100m buffer divided by the area of the 100m buffer * 100. 
13: dist_cover- continuous variable straight line distance from the record to closest polygon where cover="FOREST", calculated as, units= meters?
14: dist-agri- continuous variable straight line distance from the record to agriculture land cover, calculated as, units= meters?
15: dist_water- continuous variable straight line distance from the record to (forest?) cover, calculated as, units= meters?
16: dist_urban- continuous variable straight line distance from the record to (forest?) cover, calculated as, units= meters?
17: geometry- Remnant variable from sf package. ignore
18: f.speed- categorical variable for speed


## Standardize continuos variables

```{r}

RoeDeer.df$zADT <- standardize(RoeDeer.df$ADT)
RoeDeer.df$zEFF <- standardize(RoeDeer.df$efficiency)
RoeDeer.df$zFOR <- standardize(RoeDeer.df$cover_fo)
RoeDeer.df$zAGR <- standardize(RoeDeer.df$cover_agri)
RoeDeer.df$zWAT <- standardize(RoeDeer.df$cover_wa)
RoeDeer.df$zURB <- standardize(RoeDeer.df$cover_urb)
RoeDeer.df$zDFR <- standardize(RoeDeer.df$dist_cover)
RoeDeer.df$zDAG <- standardize(RoeDeer.df$dist_agri)
RoeDeer.df$zDWA <- standardize(RoeDeer.df$dist_water)


```

# Corrrelations

Below I look at the correlations between continuous variables in the dataset to determine which can be included together in the same model

```{r}


RD_NumCov <- RoeDeer.df[,c(6,8:16)]
C <- cor(RD_NumCov)


corrplot(C,
         type = "upper",
         order="hclust",
         addCoef.col = "black")


```

There are a few covariates that are highly correlated and cannot be included in the same model:
The amount of urban cover is highly correlated (-0.64) with speed limit
Forest cover is highly correlated with distance to forest (-0.63) and distance to agriculture (-0.59).

# Univariate Models

## Intercept only

```{r}
UnivariateModels<-list()

UnivariateModels[[1]]<-INT<-glm(response~1,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))
summary(INT)

Prob.Int <- logit2prob(INT$coefficients[1])

```


## Speed

### continuous discrete

```{r}

UnivariateModels[[2]]<-SPD.c<-glm(response ~ speed,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))


```

### categorical (factor)

```{r}

UnivariateModels[[3]]<-SPD.f<-glm(response ~ f.speed,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))


```


## Traffic volume
```{r}

UnivariateModels[[4]]<-TRAF<-glm(response ~ zADT,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))
```


## Forest Cover

```{r}

UnivariateModels[[5]]<-FORCOV<-glm(response ~ zFOR,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))

```


## Agriculture Cover

```{r}

UnivariateModels[[6]]<-AGCOV<-glm(response ~ zAGR,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))

```


## Water Cover

```{r}

UnivariateModels[[7]]<-WACOV<-glm(response ~ zWAT,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))

```


## Urban cover

```{r}

UnivariateModels[[8]]<-URBCOV<-glm(response ~ zURB,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))

```


## Distance to forest

```{r}

UnivariateModels[[9]]<-DISFOR<-glm(response ~ zDFR,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))

```


## Distance to Agriculture

```{r}

UnivariateModels[[10]]<-DISTAG<-glm(response ~ zDAG,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))

```


## Distance to water

```{r}

UnivariateModels[[11]]<-DISWA<-glm(response ~ zDWA,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))

```


## Road Efficiency

```{r}

UnivariateModels[[12]]<-REFF<-glm(response ~ zEFF,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))
```



## Univariate AICc table

```{r}

UnivariateModnames <- c("INTERCEPT", "SPEEDc", "SPEEDf", "TRAFFIC",
                        "FOREST COVER", "AG COVER", "WATER COVER","URBAN COVER",
                        "DIST FOREST","DIST AG","DIST WATER", "EFFICIENCY")

##generate AICc table

aictab(cand.set = UnivariateModels,
       modnames = UnivariateModnames, sort = TRUE, second.ord=TRUE)

##round to 4 digits after decimal point and give log-likelihood
print(aictab(cand.set = UnivariateModels,
             modnames = UnivariateModnames,
             sort = TRUE),
      digits = 4,
      LL = TRUE)

write.csv(aictab(cand.set = UnivariateModels,
                 modnames = UnivariateModnames,
                 sort = TRUE,
                 second.ord=TRUE),
          file="Results\\UnivariateModelSelectionTable.csv")


```


Based on the AICc table, all of the covariates did a better job at explaining variation in the data than the intercept only, so I will carry all covariates through

# Bivariate models with focus on speed

Distance to forest was the best univariate model, so I will include it in the bivariate model list as a comparison.

The categorical covariate for speed out-performed the continuous covariate, so I will use that one in further modeling steps.

```{r}

BivariateModels<-list()

BivariateModels[[1]]<-DISFOR

```


## Speed & Distance to forest

```{r}

BivariateModels[[2]]<-SPD.f_DFOR<-glm(response ~ f.speed+zDFR,
                        data = RoeDeer.df,
                        family = binomial(link="logit"))

```


## Bivariate AICc table

```{r}

BivariateModnames <- c("DIST FOREST","SPEEDc_DIST FOREST")


## generate and print AICc table
print(aictab(cand.set = BivariateModels,
             modnames = BivariateModnames,
             sort = TRUE),
      digits = 4, #round to 4 digits after decimal point
      LL = TRUE #give log-likelihood
      )

write.csv(aictab(cand.set = BivariateModels,
                 modnames = BivariateModnames,
                 sort = TRUE,
                 second.ord=TRUE),
          file="Results\\BivariateModelSelectionTable.csv")


```


# Top Model output

```{r}

summary(SPD.c_Traf)


Prob.40 <- logit2prob(SPD.c_Traf$coefficients[1]+
  (SPD.c_Traf$coefficients[2]*40)+
  (SPD.c_Traf$coefficients[3]*mean(RoeDeer.df$ADT)))


Prob.50 <- logit2prob(SPD.c_Traf$coefficients[1]+
  (SPD.c_Traf$coefficients[2]*50)+
  (SPD.c_Traf$coefficients[3]*mean(RoeDeer.df$ADT)))

Prob.60 <- logit2prob(SPD.c_Traf$coefficients[1]+
  (SPD.c_Traf$coefficients[2]*60)+
  (SPD.c_Traf$coefficients[3]*mean(RoeDeer.df$ADT)))

Prob.75 <- logit2prob(SPD.c_Traf$coefficients[1]+
  (SPD.c_Traf$coefficients[2]*75)+
  (SPD.c_Traf$coefficients[3]*mean(RoeDeer.df$ADT)))



RoeDeer.df$FIT<-fitted(SPD.c_Traf)

PredColl<-ggpredict(SPD.c_Traf, terms = "speed")

ggplot()+
  geom_errorbar(data = PredColl,
                aes(x, predicted,ymin=conf.low, ymax=conf.high),
                width=0.3, linewidth=1)+
  geom_point(data = PredColl, aes(x, predicted),
             size=2,
             color="red")+
  scale_x_continuous(expand = c(0.01,0.01))+
  scale_y_continuous(expand = c(0,0),
                     breaks = seq(0,1,0.1),
                     limits = c(0,0.5))+
  ylab("Probability of collision")+
  xlab("Speed limit (km/h)")
 

```


